<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Job Application Tracker system </title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #f5f5f5;
      color: #333;
    }
    .navbar {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 15px 30px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .navbar h1 {
      font-size: 1.5em;
    }
    .navbar-right {
      display: flex;
      gap: 20px;
      align-items: center;
    }
    .user-info {
      font-size: 0.95em;
    }
    button {
      background: white;
      color: #667eea;
      border: none;
      padding: 8px 15px;
      border-radius: 5px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s;
    }
    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
    }
    .container {
      max-width: 1200px;
      margin: 20px auto;
      padding: 0 20px;
    }
    .card {
      background: white;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      padding: 20px;
      margin-bottom: 20px;
    }
    .form-section {
      background: white;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      margin-bottom: 30px;
    }
    h2 {
      color: #667eea;
      margin-bottom: 20px;
      border-bottom: 2px solid #667eea;
      padding-bottom: 10px;
    }
    .form-group {
      margin-bottom: 15px;
    }
    label {
      display: block;
      margin-bottom: 5px;
      font-weight: 600;
      color: #555;
    }
    input, textarea, select {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-size: 1em;
      font-family: inherit;
    }
    input:focus, textarea:focus, select:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    textarea {
      resize: vertical;
      min-height: 100px;
    }
    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
    }
    .btn-submit {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 12px 30px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-weight: 600;
      font-size: 1em;
    }
    .btn-submit:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
    }
    .message {
      padding: 15px;
      border-radius: 5px;
      margin-bottom: 20px;
      display: none;
    }
    .message.success {
      background: #e8f5e9;
      color: #2e7d32;
      border: 1px solid #81c784;
      display: block;
    }
    .message.error {
      background: #ffebee;
      color: #c62828;
      border: 1px solid #ef5350;
      display: block;
    }
    .job-card, .app-card {
      background: #f9f9f9;
      border-left: 4px solid #667eea;
      padding: 15px;
      margin-bottom: 15px;
      border-radius: 5px;
    }
    .job-card h3, .app-card h3 {
      color: #333;
      margin-bottom: 10px;
    }
    .job-card p, .app-card p {
      color: #666;
      margin-bottom: 8px;
      font-size: 0.95em;
    }
    .status-badge {
      display: inline-block;
      padding: 5px 12px;
      border-radius: 20px;
      font-size: 0.85em;
      font-weight: 600;
      margin-top: 10px;
    }
    .status-pending { background: #fff3e0; color: #e65100; }
    .status-received { background: #e3f2fd; color: #1565c0; }
    .status-interview { background: #f3e5f5; color: #6a1b9a; }
    .status-selected { background: #e8f5e9; color: #1b5e20; }
    .status-rejected { background: #ffebee; color: #b71c1c; }
    .status-open { background: #e8f5e9; color: #1b5e20; }
    .status-closed { background: #f3e5f5; color: #4a148c; }
    .action-buttons {
      display: flex;
      gap: 10px;
      margin-top: 10px;
      flex-wrap: wrap;
    }
    .btn-small {
      padding: 6px 12px;
      font-size: 0.9em;
      background: #667eea;
      color: white;
      border: none;
      border-radius: 3px;
      cursor: pointer;
    }
    .btn-small:hover { background: #5568d3; }
    .btn-danger { background: #f44336; }
    .btn-danger:hover { background: #da190b; }
    .hidden { display: none; }
    .auth-page {
      max-width: 400px;
      margin: 50px auto;
      background: white;
      padding: 40px;
      border-radius: 10px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
    }
    .auth-page h2 { text-align: center; border: none; margin-bottom: 30px; }
    .role-selector {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 10px;
      margin-bottom: 20px;
    }
    .role-option {
      padding: 10px;
      border: 2px solid #ddd;
      border-radius: 5px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s;
    }
    .role-option.selected { border-color: #667eea; background: #f0f4ff; }
    .role-option:hover { border-color: #667eea; }
    .empty-state { text-align: center; padding: 40px; color: #999; }
    .dashboard {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    .stat-card {
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      text-align: center;
    }
    .stat-card .number { font-size: 2.5em; color: #667eea; font-weight: bold; }
    .stat-card .label { color: #666; margin-top: 10px; }
    @media (max-width: 768px) {
      .form-row { grid-template-columns: 1fr; }
      .navbar { flex-direction: column; gap: 10px; }
      .navbar-right { flex-direction: column; width: 100%; }
    }
  </style>
</head>
<body>
  <!-- Auth Page -->
  <div id="authPage" class="hidden">
    <div class="auth-page">
      <h2 id="authTitle">Login</h2>
      <div id="authMessage" class="message"></div>
      
      <div id="loginForm">
        <div class="form-group">
          <label for="loginEmail">Email</label>
          <input type="email" id="loginEmail" placeholder="your@email.com">
        </div>
        <div class="form-group">
          <label for="loginPassword">Password</label>
          <input type="password" id="loginPassword" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
        </div>
        <button class="btn-submit" style="width: 100%; margin-bottom: 10px;" onclick="login()">Login</button>
        <p style="text-align: center; margin-top: 15px; color: #666;">
          Don't have an account? <a href="#" onclick="toggleAuthForm(); return false;" style="color: #667eea; cursor: pointer;">Register</a>
        </p>
      </div>

      <div id="registerForm" class="hidden">
        <div class="form-group">
          <label>Select Your Role</label>
          <div class="role-selector">
            <div class="role-option" onclick="selectRole('publisher')">
              <strong>Publisher</strong><br><small>Post jobs</small>
            </div>
            <div class="role-option" onclick="selectRole('applicant')">
              <strong>Applicant</strong><br><small>Apply for jobs</small>
            </div>
            <div class="role-option" onclick="selectRole('approver')">
              <strong>Approver</strong><br><small>Review applications</small>
            </div>
          </div>
        </div>
        <div class="form-group">
          <label for="regName">Full Name</label>
          <input type="text" id="regName" placeholder="Your name">
        </div>
        <div class="form-group">
          <label for="regEmail">Email</label>
          <input type="email" id="regEmail" placeholder="your@email.com">
        </div>
        <div class="form-group">
          <label for="regPassword">Password</label>
          <input type="password" id="regPassword" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
        </div>
        <button class="btn-submit" style="width: 100%; margin-bottom: 10px;" onclick="register()">Register</button>
        <p style="text-align: center; margin-top: 15px; color: #666;">
          Already have an account? <a href="#" onclick="toggleAuthForm(); return false;" style="color: #667eea; cursor: pointer;">Login</a>
        </p>
      </div>
    </div>
  </div>

  <!-- Main App -->
  <div id="mainApp" class="hidden">
    <div class="navbar">
      <h1>ðŸ’¼ Job Tracker</h1>
      <div class="navbar-right">
        <div class="user-info">
          ðŸ‘¤ <strong id="userName"></strong> <small id="userRole"></small>
        </div>
        <button onclick="logout()">Logout</button>
      </div>
    </div>

    <div class="container">
      <!-- Publisher Dashboard -->
      <div id="publisherSection" class="hidden">
        <div class="dashboard">
          <div class="stat-card">
            <div class="number" id="totalJobs">0</div>
            <div class="label">Jobs Posted</div>
          </div>
          <div class="stat-card">
            <div class="number" id="totalApplications">0</div>
            <div class="label">Total Applications</div>
          </div>
        </div>

        <div class="form-section">
          <h2>Post New Job</h2>
          <div id="publisherMessage" class="message"></div>
          <form id="jobForm">
            <div class="form-row">
              <div class="form-group">
                <label for="jobTitle">Job Title *</label>
                <input type="text" id="jobTitle" required>
              </div>
              <div class="form-group">
                <label for="jobLocation">Location</label>
                <input type="text" id="jobLocation">
              </div>
            </div>
            <div class="form-group">
              <label for="jobDescription">Description *</label>
              <textarea id="jobDescription" required></textarea>
            </div>
            <div class="form-group">
              <label for="jobSalary">Salary Range</label>
              <input type="text" id="jobSalary" placeholder="e.g., $50k-$70k">
            </div>
            <button type="submit" class="btn-submit">Post Job</button>
          </form>
        </div>

        <h2>Your Job Postings</h2>
        <div id="publisherJobsList"></div>
      </div>

      <!-- Applicant Dashboard -->
      <div id="applicantSection" class="hidden">
        <h2>Available Jobs</h2>
        <div id="availableJobsList"></div>

        <h2 style="margin-top: 40px;">My Applications</h2>
        <div id="myApplicationsList"></div>
      </div>

      <!-- Approver Dashboard -->
      <div id="approverSection" class="hidden">
        <div class="dashboard">
          <div class="stat-card">
            <div class="number" id="pendingCount">0</div>
            <div class="label">Pending Applications</div>
          </div>
          <div class="stat-card">
            <div class="number" id="interviewCount">0</div>
            <div class="label">Interview Stage</div>
          </div>
          <div class="stat-card">
            <div class="number" id="selectedCount">0</div>
            <div class="label">Selected</div>
          </div>
        </div>

        <h2>Manage Applications</h2>
        <div id="approverApplicationsList"></div>
      </div>
    </div>
  </div>

  <script>
    const API = 'http://localhost:3000/api';
    let currentUser = null;
    let selectedRole = null;

    function toggleAuthForm() {
      document.getElementById('loginForm').classList.toggle('hidden');
      document.getElementById('registerForm').classList.toggle('hidden');
      document.getElementById('authTitle').textContent = 
        document.getElementById('loginForm').classList.contains('hidden') ? 'Register' : 'Login';
    }

    function selectRole(role) {
      selectedRole = role;
      document.querySelectorAll('.role-option').forEach(el => el.classList.remove('selected'));
      event.target.closest('.role-option').classList.add('selected');
    }

    async function login() {
      const email = document.getElementById('loginEmail').value;
      const password = document.getElementById('loginPassword').value;

      try {
        const res = await fetch(`${API}/auth/login`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password })
        });

        const data = await res.json();
        if (res.ok) {
          currentUser = data.user;
          localStorage.setItem('token', data.token);
          localStorage.setItem('user', JSON.stringify(data.user));
          showApp();
        } else {
          showAuthMessage(data.error, 'error');
        }
      } catch (error) {
        showAuthMessage('Login failed: ' + error.message, 'error');
      }
    }

    async function register() {
      const name = document.getElementById('regName').value;
      const email = document.getElementById('regEmail').value;
      const password = document.getElementById('regPassword').value;
      const role = selectedRole;

      if (!role) {
        showAuthMessage('Please select a role', 'error');
        return;
      }

      try {
        const res = await fetch(`${API}/auth/register`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password, name, role })
        });

        const data = await res.json();
        if (res.ok) {
          currentUser = data.user;
          localStorage.setItem('token', data.token);
          localStorage.setItem('user', JSON.stringify(data.user));
          showApp();
        } else {
          showAuthMessage(data.error, 'error');
        }
      } catch (error) {
        showAuthMessage('Registration failed: ' + error.message, 'error');
      }
    }

    function logout() {
      localStorage.removeItem('token');
      localStorage.removeItem('user');
      currentUser = null;
      selectedRole = null;
      document.getElementById('authPage').classList.remove('hidden');
      document.getElementById('mainApp').classList.add('hidden');
      document.getElementById('loginForm').classList.remove('hidden');
      document.getElementById('registerForm').classList.add('hidden');
      document.getElementById('loginEmail').value = '';
      document.getElementById('loginPassword').value = '';
    }

    function showAuthMessage(msg, type) {
      const el = document.getElementById('authMessage');
      el.textContent = msg;
      el.className = `message ${type}`;
      setTimeout(() => {
        el.className = 'message';
        el.textContent = '';
      }, 4000);
    }

    function showApp() {
      document.getElementById('authPage').classList.add('hidden');
      document.getElementById('mainApp').classList.remove('hidden');
      document.getElementById('userName').textContent = currentUser.name;
      document.getElementById('userRole').textContent = `(${currentUser.role})`;

      document.getElementById('publisherSection').classList.toggle('hidden', currentUser.role !== 'publisher');
      document.getElementById('applicantSection').classList.toggle('hidden', currentUser.role !== 'applicant');
      document.getElementById('approverSection').classList.toggle('hidden', currentUser.role !== 'approver');

      if (currentUser.role === 'publisher') loadPublisherData();
      if (currentUser.role === 'applicant') loadApplicantData();
      if (currentUser.role === 'approver') loadApproverData();
    }

    document.getElementById('jobForm')?.addEventListener('submit', async (e) => {
      e.preventDefault();
      const jobData = {
        title: document.getElementById('jobTitle').value,
        description: document.getElementById('jobDescription').value,
        location: document.getElementById('jobLocation').value,
        salary_range: document.getElementById('jobSalary').value
      };

      try {
        const res = await fetch(`${API}/jobs`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${localStorage.getItem('token')}`
          },
          body: JSON.stringify(jobData)
        });

        if (res.ok) {
          document.getElementById('jobForm').reset();
          document.getElementById('publisherMessage').textContent = 'Job posted successfully!';
          document.getElementById('publisherMessage').className = 'message success';
          setTimeout(() => loadPublisherData(), 500);
        } else {
          const data = await res.json();
          document.getElementById('publisherMessage').textContent = data.error;
          document.getElementById('publisherMessage').className = 'message error';
        }
      } catch (error) {
        document.getElementById('publisherMessage').textContent = 'Error: ' + error.message;
        document.getElementById('publisherMessage').className = 'message error';
      }
    });

    async function loadPublisherData() {
      try {
        const token = localStorage.getItem('token');
        const res = await fetch(`${API}/jobs`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        const jobs = await res.json();

        let html = '';
        let totalApps = 0;

        for (const job of jobs) {
          if (job.publisher_id === currentUser.id) {
            try {
              const appRes = await fetch(`${API}/applications/job/${job.id}`, {
                headers: { 'Authorization': `Bearer ${token}` }
              });
              const apps = await appRes.json();
              totalApps += apps.length;
              
              html += `
                <div class="job-card">
                  <h3>${job.title}</h3>
                  <p><strong>Location:</strong> ${job.location || 'N/A'}</p>
                  <p><strong>Salary:</strong> ${job.salary_range || 'N/A'}</p>
                  <p>${job.description.substring(0, 100)}...</p>
                  <span class="status-badge status-${job.status}">${job.status}</span>
                  <p style="margin-top: 10px;"><strong>Applications: ${apps.length || 0}</strong></p>
                </div>
              `;
            } catch (e) {
              html += `<div class="job-card"><h3>${job.title}</h3><p>Error loading applications</p></div>`;
            }
          }
        }

        document.getElementById('totalJobs').textContent = jobs.filter(j => j.publisher_id === currentUser.id).length;
        document.getElementById('totalApplications').textContent = totalApps;
        document.getElementById('publisherJobsList').innerHTML = html || '<div class="empty-state">No jobs posted yet</div>';
      } catch (error) {
        console.error('Error loading publisher data:', error);
      }
    }

    async function loadApplicantData() {
      try {
        const token = localStorage.getItem('token');

        const jobRes = await fetch(`${API}/jobs`);
        const jobs = await jobRes.json();

        let html = '';
        for (const job of jobs) {
          html += `
            <div class="job-card">
              <h3>${job.title}</h3>
              <p><strong>Company:</strong> ${job.publisher_name}</p>
              <p><strong>Location:</strong> ${job.location || 'N/A'}</p>
              <p><strong>Salary:</strong> ${job.salary_range || 'N/A'}</p>
              <p>${job.description.substring(0, 150)}...</p>
              <button class="btn-small" onclick="openApplyModal(${job.id}, '${job.title.replace(/'/g, "\\'")}')">Apply Now</button>
            </div>
          `;
        }
        document.getElementById('availableJobsList').innerHTML = html || '<div class="empty-state">No jobs available</div>';

        const appRes = await fetch(`${API}/applications/my-applications`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        const apps = await appRes.json();

        let appHtml = '';
        for (const app of apps) {
          appHtml += `
            <div class="app-card">
              <h3>${app.title}</h3>
              <p><strong>Company:</strong> ${app.publisher_name}</p>
              <p><strong>Applied:</strong> ${new Date(app.created_at).toLocaleDateString()}</p>
              <span class="status-badge status-${app.status}">${app.status}</span>
              ${app.rejection_reason ? `<p style="color: #d32f2f; margin-top: 10px;"><strong>Reason:</strong> ${app.rejection_reason}</p>` : ''}
            </div>
          `;
        }
        document.getElementById('myApplicationsList').innerHTML = appHtml || '<div class="empty-state">No applications yet</div>';
      } catch (error) {
        console.error('Error loading applicant data:', error);
      }
    }

    function openApplyModal(jobId, jobTitle) {
      const coverLetter = prompt(`Write a cover letter for: ${jobTitle}`, '');
      if (coverLetter) {
        submitApplication(jobId, coverLetter);
      }
    }

    async function submitApplication(jobId, coverLetter) {
      try {
        const res = await fetch(`${API}/applications`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${localStorage.getItem('token')}`
          },
          body: JSON.stringify({
            job_id: jobId,
            cover_letter: coverLetter
          })
        });

        if (res.ok) {
          alert('Application submitted successfully!');
          loadApplicantData();
        } else {
          const data = await res.json();
          alert('Error: ' + data.error);
        }
      } catch (error) {
        alert('Error: ' + error.message);
      }
    }

    async function loadApproverData() {
      try {
        const token = localStorage.getItem('token');
        const jobRes = await fetch(`${API}/jobs`);
        const jobs = await jobRes.json();

        let html = '';
        let pending = 0, interview = 0, selected = 0;

        for (const job of jobs) {
          try {
            const appRes = await fetch(`${API}/applications/job/${job.id}`, {
              headers: { 'Authorization': `Bearer ${token}` },
              method: 'GET'
            });
            const apps = await appRes.json();

            for (const app of apps) {
              if (app.status === 'pending') pending++;
              if (app.status === 'interview') interview++;
              if (app.status === 'selected') selected++;

              html += `
                <div class="app-card">
                  <h3>${app.applicant_name} - ${job.title}</h3>
                  <p><strong>Email:</strong> ${app.applicant_email}</p>
                  <p><strong>Applied:</strong> ${new Date(app.created_at).toLocaleDateString()}</p>
                  <span class="status-badge status-${app.status}">${app.status}</span>
                  <div class="action-buttons">
                    <button class="btn-small" onclick="updateAppStatus(${app.id}, 'received')">Received</button>
                    <button class="btn-small" onclick="updateAppStatus(${app.id}, 'interview')">Interview</button>
                    <button class="btn-small" onclick="updateAppStatus(${app.id}, 'selected')">Selected</button>
                    <button class="btn-small btn-danger" onclick="rejectApp(${app.id})">Reject</button>
                  </div>
                </div>
              `;
            }
          } catch (e) {
            console.error('Error loading applications:', e);
          }
        }

        document.getElementById('pendingCount').textContent = pending;
        document.getElementById('interviewCount').textContent = interview;
        document.getElementById('selectedCount').textContent = selected;
        document.getElementById('approverApplicationsList').innerHTML = html || '<div class="empty-state">No applications</div>';
      } catch (error) {
        console.error('Error loading approver data:', error);
      }
    }

    async function updateAppStatus(appId, status) {
      try {
        const res = await fetch(`${API}/applications/${appId}/status`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${localStorage.getItem('token')}`
          },
          body: JSON.stringify({ status })
        });

        if (res.ok) {
          alert('Status updated!');
          loadApproverData();
        } else {
          alert('Error updating status');
        }
      } catch (error) {
        alert('Error: ' + error.message);
      }
    }

    function rejectApp(appId) {
      const reason = prompt('Rejection reason:');
      if (reason) {
        updateAppStatusWithReason(appId, 'rejected', reason);
      }
    }

    async function updateAppStatusWithReason(appId, status, reason) {
      try {
        const res = await fetch(`${API}/applications/${appId}/status`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${localStorage.getItem('token')}`
          },
          body: JSON.stringify({ status, rejection_reason: reason })
        });

        if (res.ok) {
          alert('Application rejected!');
          loadApproverData();
        }
      } catch (error) {
        alert('Error: ' + error.message);
      }
    }

    window.addEventListener('DOMContentLoaded', () => {
      const token = localStorage.getItem('token');
      const user = localStorage.getItem('user');

      if (token && user) {
        currentUser = JSON.parse(user);
        showApp();
      } else {
        document.getElementById('authPage').classList.remove('hidden');
      }
    });
  </script>
</body>
</html>
