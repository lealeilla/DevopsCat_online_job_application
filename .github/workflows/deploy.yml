name: Deploy to Kubernetes

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        type: choice
        options:
          - production
          - staging
      image_tag:
        description: 'Docker image tag to deploy'
        required: true
        default: 'latest'
  push:
    tags:
      - 'v*'

permissions:
  contents: read
  packages: read

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: 
      name: ${{ github.event.inputs.environment || 'production' }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Determine image tag
        id: image_tag
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            TAG=${{ github.event.inputs.image_tag }}
          else
            TAG=${GITHUB_REF#refs/tags/v}
          fi
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "Deploying image tag: $TAG"

      - name: Set up kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'v1.28.0'

      - name: Configure kubeconfig
        run: |
          mkdir -p ~/.kube
          echo "${{ secrets.KUBE_CONFIG }}" | base64 -d > ~/.kube/config
          chmod 600 ~/.kube/config

      - name: Update deployment image
        run: |
          kubectl set image deployment/ojat-app \
            ojat=${{ secrets.DOCKER_USERNAME }}/devops_cat_onlinejob:${{ steps.image_tag.outputs.tag }} \
            -n ojat-production \
            --record

      - name: Wait for rollout to complete
        run: |
          kubectl rollout status deployment/ojat-app -n ojat-production --timeout=5m

      - name: Verify deployment
        run: |
          kubectl get pods -n ojat-production -l app=ojat
          kubectl get deployment ojat-app -n ojat-production
          kubectl get hpa ojat-hpa -n ojat-production

      - name: Run smoke tests
        run: |
          SERVICE_IP=$(kubectl get svc ojat-service -n ojat-production -o jsonpath='{.status.loadBalancer.ingress[0].ip}')
          if [ -z "$SERVICE_IP" ]; then
            echo "Waiting for LoadBalancer IP..."
            sleep 30
            SERVICE_IP=$(kubectl get svc ojat-service -n ojat-production -o jsonpath='{.status.loadBalancer.ingress[0].ip}')
          fi
          
          if [ -n "$SERVICE_IP" ]; then
            echo "Testing health endpoint..."
            curl -f http://$SERVICE_IP/health || exit 1
            echo "Deployment successful!"
          else
            echo "Warning: LoadBalancer IP not available yet"
          fi

      - name: Rollback on failure
        if: failure()
        run: |
          echo "Deployment failed, rolling back..."
          kubectl rollout undo deployment/ojat-app -n ojat-production
          kubectl rollout status deployment/ojat-app -n ojat-production --timeout=3m

      - name: Notify Slack - Deployment
        if: always() && env.SLACK_WEBHOOK_URL != ''
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          text: |
            ðŸš€ *Deployment to ${{ github.event.inputs.environment || 'production' }}*
            
            *Status:* ${{ job.status }}
            *Image:* ${{ secrets.DOCKER_USERNAME }}/devops_cat_onlinejob:${{ steps.image_tag.outputs.tag }}
            *Repository:* ${{ github.repository }}
            *Triggered by:* ${{ github.actor }}
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        continue-on-error: true
