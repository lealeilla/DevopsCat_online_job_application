name: Deploy to Kubernetes

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        type: choice
        options:
          - production
          - staging
      image_tag:
        description: 'Docker image tag to deploy'
        required: true
        default: 'latest'
  workflow_run:
    workflows: ["Release & Versioning"]
    types:
      - completed

permissions:
  contents: read
  packages: read

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' || (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success')
    environment: 
      name: ${{ github.event.inputs.environment || 'production' }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check Kubernetes credentials
        id: check_kube
        env:
          KUBE_CONFIG: ${{ secrets.KUBE_CONFIG }}
        run: |
          if [ -z "$KUBE_CONFIG" ]; then
            echo "configured=false" >> $GITHUB_OUTPUT
            echo "âš ï¸ KUBE_CONFIG secret not configured. Skipping deployment."
          else
            echo "configured=true" >> $GITHUB_OUTPUT
            echo "âœ… Kubernetes credentials found"
          fi

      - name: Determine image tag
        id: image_tag
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            TAG=${{ github.event.inputs.image_tag }}
          elif [ "${{ github.event_name }}" = "workflow_run" ]; then
            TAG=$(echo "${{ github.event.workflow_run.head_branch }}" | sed 's/refs\/tags\///' | sed 's/^v//')
          else
            TAG=latest
          fi
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "ðŸš€ Image tag: $TAG"

      - name: Deployment Summary (No Kubernetes)
        if: steps.check_kube.outputs.configured == 'false'
        env:
          DOCKER_USER: ${{ secrets.DOCKER_USERNAME }}
        run: |
          echo "=========================================="
          echo "ðŸ“¦ DEPLOYMENT SUMMARY"
          echo "=========================================="
          echo ""
          echo "Docker image ready:"
          echo "  docker pull $DOCKER_USER/devops_cat_onlinejob:${{ steps.image_tag.outputs.tag }}"
          echo ""
          echo "To deploy manually:"
          echo "  kubectl set image deployment/ojat-app ojat=$DOCKER_USER/devops_cat_onlinejob:${{ steps.image_tag.outputs.tag }} -n ojat-production"
          echo ""
          echo "To enable auto-deploy, add KUBE_CONFIG secret"
          echo "=========================================="

      - name: Set up kubectl
        if: steps.check_kube.outputs.configured == 'true'
        uses: azure/setup-kubectl@v3
        with:
          version: 'v1.28.0'

      - name: Configure kubeconfig
        if: steps.check_kube.outputs.configured == 'true'
        env:
          KUBE_CONFIG: ${{ secrets.KUBE_CONFIG }}
        run: |
          mkdir -p ~/.kube
          echo "$KUBE_CONFIG" | base64 -d > ~/.kube/config
          chmod 600 ~/.kube/config

      - name: Update deployment image
        if: steps.check_kube.outputs.configured == 'true'
        env:
          DOCKER_USER: ${{ secrets.DOCKER_USERNAME }}
        run: |
          kubectl set image deployment/ojat-app \
            ojat=$DOCKER_USER/devops_cat_onlinejob:${{ steps.image_tag.outputs.tag }} \
            -n ojat-production

      - name: Wait for rollout
        if: steps.check_kube.outputs.configured == 'true'
        run: kubectl rollout status deployment/ojat-app -n ojat-production --timeout=5m

      - name: Verify deployment
        if: steps.check_kube.outputs.configured == 'true'
        run: |
          kubectl get pods -n ojat-production -l app=ojat
          kubectl get deployment ojat-app -n ojat-production

      - name: Rollback on failure
        if: failure() && steps.check_kube.outputs.configured == 'true'
        run: |
          kubectl rollout undo deployment/ojat-app -n ojat-production
          kubectl rollout status deployment/ojat-app -n ojat-production --timeout=3m
